<!DOCTYPE html>
<head>

    <title>Hello World</title>
    <meta charset="utf-8" />
    <script type="text/javascript" src="/static/ender.js"></script>
    <script type="text/javascript">

    /* utility functions -- JS Y U SO STUPID? */
    function read(cookie){
        return(document.cookie.match('(^|; )' + cookie + '=([^;]*)') || 0)[2]
    };

    function zfill(arg, i) {
        var res = String(arg);
        if (res.length < i) {
            for (var j = 0; j <= (i - res.length); j++) {
                res = '0' + res;
            };
        }

        return res;
    }

    var createForm = function(id, func) {
        /*
        Returns HTML for form and registers submit call.

        Synopsis: `isso_N` is the comment with the id N. `issoform` is a new
        form to write an answer to the article or answer to a comment using
        `issoform_N` where N is the id to respond to.

        :param id: comment id
        :param func: function, that takes one argument (the HTML to display the form)
        */

        var formid = 'issoform' + (id ? ('_' + id) : '');
        var form =
        '<div class="issoform" id="' + formid + '">' +
            '<div>' +
            '    <input type="text" name="name" id="author" value="" placeholder="Name">' +
            '</div>' +
            '<div>' +
            '    <input type="email" name="email" id="email" value="" placeholder="Email">' +
            '</div>' +
            '<div>' +
                '<input type="url" name="website" id="website" value="" placeholder="Website URL">' +
            '</div>' +
            '<div>' +
            '    <textarea rows="10" name="comment" id="comment" placeholder="Comment"></textarea>' +
            '</div>' +
            '<div>' +
                '<input type="submit" name="submit" value="Add Comment">' +
            '</div>' +
        '</div>'

        func(form);

        // register submit event
        $('#' + formid + ' ' + 'input[type="submit"]').on('click', function() {

            var text = $('textarea[id="comment"]').val() || null;

            if (text == null) {
                // alert("You must write a comment!");
                return;
            }

            $.ajax({
                url: '/comment/' + encodeURIComponent(window.location.pathname) + '/new',
                method: 'POST',
                type: 'json',
                headers: {
                    'Content-Type': 'application/json',
                },
                data: JSON.stringify({
                    text: text,
                    author: $('input[id="author"]').val() || null,
                    email: $('input[id="email"]').val() || null,
                    website: $('input[id="website"]').val() || null,
                    parent: id
                }),
                error: function(resp) {
                    alert("Mööp.");
                },
                success: function(rv) {
                    insert($('#isso_thread'), rv)
                },
            });

            // close form after reply
            if (id) {
                $('#' + formid).remove();
            }
        });
    };

    var initialize = function(thread) {

        // that with an unordered list
        thread.append('<ul id="comments"></ul>');

        // load our css
        $('head').append('<link rel="stylesheet" href="/static/style.css" />');

        // append form
        createForm(null, function(html) {thread.append(html)});
    };

    var insert = function(thread, post) {
        /*
        Insert a comment into #isso_thread.

        :param thread: XXX remove this
        :param post: JSON from API call
        */

        // pythonic strftime
        var format = function(date, lang, fmt) {

            var months = {'de': [
                'Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli',
                'August', 'September', 'Oktober', 'November', 'Dezember'],
                          'en': [
                'January', 'February', 'March', 'April', 'May', 'June', 'July',
                'August', 'September', 'October', 'November', 'December'],
            };

            var conversions = [
                ['%Y', date.getFullYear()], ['%m', zfill(date.getMonth(), 2)],
                ['%B', months[lang][date.getMonth() - 1]],
                ['%d', zfill(date.getDate(), 2)], ['%H', zfill(date.getHours(), 2)],
                ['%H', zfill(date.getHours(), 2)], ['%M', zfill(date.getMinutes(), 2)],
            ];

            conversions.map(function(item) { fmt = fmt.replace(item[0], item[1]) });
            return fmt;
        };

        var author = post['author'] || 'Anonymous';
        if (post['website']) {
            author = '<a href="' + post['website'] + '" rel="nofollow">' + author + '</a>';
        }

        var date = new Date(parseInt(post['created']) * 1000);

        // create <ul /> for parent, if used
        if (post['parent']) {
            $('#isso_' + post['parent']).append('<ul></ul>');
        }

        $(post['parent'] ? '#isso_' + post['parent'] + ' > ul:last-child' : '#isso_thread > ul').append(
            '<article class="isso" id="isso_' + post['id'] + '">' +
            '  <header><span class="author">' + author + '</span>' +
            '  </header>' + post['text'] +
            '  <footer>' +
            '    <a href="#">Antworten</a>' +
            '    <a href="#isso_' + post['id'] + '">#' + post['id'] + '</a>' +
            '    <span class="date">' + format(date, 'de', '%d.%m.%Y um %H:%M') +
            '    </span>' +
            '  </footer>' +
            '</article>');

        if (read('session-' + encodeURIComponent(window.location.pathname) + '-' + post['id'])) {
            var node = $('#isso_' + post['id'] + '> footer > a:first-child')
                .after('<a href="#">Bearbeiten</a>');

        }

        // ability to answer directly to a comment
        $('footer > a:first-child', '#isso_' + post['id']).on('click', function(event) {

            if ($('#issoform_' + post['id']).length == 0) {
                createForm(post['id'], function(html) {$('#isso_' + post['id']).after(html)});
            } else {
                $('#issoform_' + post['id']).remove();
            };
            event.stop();
        });
    };

    var fetch = function(thread) {
        var rv = $.ajax({
            url: '/comment/' + encodeURIComponent(window.location.pathname) + '/',
            method: 'GET',
            type: 'json',
            headers: {
                'Content-Type': 'application/json',
            },
            error: function(resp) {
                return;
            },
            success: function(resp) {
                for (var item in resp) {
                    insert(thread, resp[item]);
                }
            }
        });
    };

    $.domReady(function() {

        // initialize comment form and css
        initialize($('#isso_thread'));

        // fetch comments for path
        fetch($('#isso_thread'));

        // REMOVE ME
        $('input[id="author"]').val("Peter");
        $('textarea[id="comment"]').val("Lorem ipsum ...");

    });

    </script>
    <style type="text/css">
        body {
          margin: 0 auto;
          width: 700px;
        }

        hr {
          border: 0;
          height: 1px;
          background-image: -moz-linear-gradient(left, rgba(0,0,0,0), rgba(0,0,0,0.75), rgba(0,0,0,0));
        }
    </style>

</head>

<body>

<article>

    <header>
        <h1>Hello World. Finally!</h1>
    </header>

    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
    tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
    quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
    consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
    cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
    proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>

    <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
    tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
    quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
    consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
    cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
    proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>

    <footer>
        <hr />
        <div id="isso_thread"></div>
        <noscript>
            <p>Please enable JavaScript to view the comments powered by Isso™.</a></p>
        </noscript>
    </footer>

</article>

</body>